#!/bin/bash

check_bridge_error() {
	echo "Для работы в режиме съема зеркала трафика с коммутатора необходимо иметь как минимум 1 bridge-интерфейс."
	echo "Его можно создать автоматически в menu -> Настройка сканирования трафика."
	echo "Список интерфейсов в системе:"
	ip link
}

is_module_load_fix() {
	echo "Модуль не загружен (возможно его выключили, либо проблема с демоном запускающим его)."
	echo "Попробуем запустить:"
	$BINDIR/start.sh
}

check_proc_values_error() {
	echo "Возможно ядро сконфигурировано сторонними утилитами недостаточно правильно для работы Reductor"
}

check_tcpdump_http_mirror_error() {
	echo "Для этого нужно настроить зеркало трафика."
	echo "Возможно проблема в настройке vlan, как вариант можно на mirror-порту коммутатора снимать тэгирование."
	echo "Если вы ещё не настраивали зеркало на этом сервере, то запустите menu -> Настройка сканирования трафика."
	echo "Если использовано зеркало с маршрутизатора, включите опцию в прочих настройках'Не проверять настройки сети при старте'"
}

check_cert_error() {
	echo "На сервере отсутствует файл $USERDIR/provider.pem, либо он пустой."
	echo "Нужно положить туда закрытый ключ экспортированный с USB-токена."
	echo "Если у вас уже есть *.pfx-контейнер, положите его в папку $USERDIR"
	echo "и запустите menu -> Настройки обновления списков с zapret-info... -> Установка сертификата с USB-Token"
}

check_key_in_cert_error() {
	echo "В файле $USERDIR/provider.pem не найден закрытый ключ."
	echo "Вот его содержимое:"
	cat $USERDIR/provider.pem
	echo "Проверьте флаги, которые выставляются при экспорте ключа с USB-токена в специальной утилите"
	echo "Если всё сделано правильно, в содержимом $USERDIR/provider.pem появится секция"
	echo "BEGIN PRIVATE KEY"
	echo "..."
	echo "END PRIVATE KEY"
	echo "А это сообщение больше не будет вас беспокоить."

}

check_total_packets_error() {
	echo "Эта ошибка означает, что в модуль Carbon Reductor ни разу не попадал пакет на проверку."
	echo "Есть две основные причины которые приводят к этому. Первая - не настроено зеркало трафика. (90% вероятности)"
	echo "Вторая - отсутствие фильтрующего правила в iptables: (10% вероятности)"
	iptables -t filter -nvL FORWARD
	iptables -t mangle -nvL PREROUTING
}

check_block_fact_error() {
	echo "Эта ошибка означает, что не происходило ни одного факта блокировки."
	echo "Вполне вероятно, что модуль был запущен относительно недавно и это просто не успело произойти"
	echo "Возможно не настроено зеркало трафика"
	echo "А также возможно что ваши абоненты - замечательные добропорядочные люди и не ходят на запрещённые сайты."
}

check_url_modify_error() {
	echo "Возможно у вас указан устаревший URL сервера обновления сигнатур."
	echo "Вероятно у вас из-за этого не активируется Carbon Reductor."
	echo "В последних версиях URL сервера активации обновляется при старте."
	echo "Данная опция в большей степени является опцией для разработчиков."
}

check_list_actuality_fix() {
	echo "Эта опция означает, что список с сервера РосКомНадзора не модифицировался более 6 часов"
	echo "Возможно это связано с ЭЦП (см проверки выше)."
	echo "Возможно также это связано с неправильными записями в crontab:"
	cat /etc/crontab
	echo "На всякий случай попробуем запустить обновление:"
	$BINDIR/update.sh
}

check_activation_fix() {
	echo "Carbon Reductor не активирован! Попробуем обратиться к серверу активации:"
	$BINDIR/load_url.sh
}

check_disk_space_error() {
	echo "На системном диске кончилось или кончается место!"
	df -H
	echo "Попытка найти занимающие больше всего места файлы и папки:"
	echo "Поиск может занимать время до одной минуты, пожалуйста подождите..."
	$BINDIR/find_big_files.sh
}
